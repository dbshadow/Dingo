# D-Link Translator

A web-based tool for translating CSV and IDML files using a local Ollama-powered Large Language Model, featuring a real-time task queue and a suite of IDML processing tools.

## âœ¨ Features

-   **Multi-User Ready**: Each user has their own API token. Users can see all tasks but can only manage (delete, download) their own.
-   **Asynchronous Task Queue**: A robust, non-blocking task queue processes uploaded jobs sequentially. Translation tasks are persistent and survive server restarts.
-   **Simplified CSV Translation**:
    -   **Header-Defined Languages**: The UI is now streamlined. Simply upload a CSV where the first column header defines the source language (e.g., `en`) and subsequent column headers define the target languages (e.g., `de`, `zh-Hant`).
    -   **Glossary Support**: Upload a `.csv` glossary to guide the LLM and ensure terminological consistency.
-   **Live Task Board**: The Web UI features a live-updating task board showing the status (`pending`, `running`, `completed`, `error`) and progress of all tasks for all connected users via WebSockets.
-   **IDML Tool-kit**: A dedicated tab for a complete Adobe InDesign workflow:
    -   **Extractor**: Extracts text from an `.idml` file into a ready-to-translate `.csv` file (using `source`/`target` columns).
    -   **Rebuilder**: Merges a translated `.csv` file back into the original `.idml` structure.
-   **Live Translator**: A simple, side-by-side interface for translating single sentences or short paragraphs on the fly.
-   **Secure & Dockerized**: Web access is protected by API Tokens, and the entire application is containerized with Docker for easy and consistent deployment.

## ğŸ“– How to Use

### CSV Translator

The CSV translation process has been simplified. You no longer need to select source or target languages in the UI. Instead, you define them directly in the header of your CSV file.

**CSV Format Rules:**

1.  **First Column is the Source**: The first column *must* contain the text you want to translate. Its header must be the BCP-47 language code for that text (e.g., `en` for English, `ja` for Japanese).
2.  **Subsequent Columns are Targets**: Every column after the first is a target for translation. The header of each of these columns must be the BCP-47 code for the language you want to translate into (e.g., `de` for German, `es` for Spanish).
3.  **Non-Destructive**: The tool will only fill in empty cells. If a cell in a target language column already has content, it will be skipped.

**Example `my_translations.csv`:**

```csv
en,zh-Hant,es,de
"Hello, world!","ä½ å¥½ï¼Œä¸–ç•Œï¼","Hola, mundo!",
"How are you?","ä½ å¥½å—ï¼Ÿ",,
"This is a test.",,,
```

When you upload this file:
- The tool will see `en` as the source language.
- It will attempt to translate into Traditional Chinese (`zh-Hant`), Spanish (`es`), and German (`de`).
- It will skip the existing translations for "Hello, world!".
- It will translate "How are you?" into Spanish and German (since those cells are empty).
- It will translate "This is a test." into all three target languages.

### IDML Tools

The **IDML to CSV Extractor** and **Rebuild IDML from CSV** tools are not affected by this change. The CSV files generated by the extractor and expected by the rebuilder still use the original, simple two-column format:

-   `source`: The text extracted from the IDML file.
-   `target`: The column where the translated text should be placed.

## ğŸ› ï¸ Tech Stack

-   **Backend**: FastAPI, Uvicorn, WebSockets
-   **Frontend**: Vanilla JavaScript, HTML5, CSS3
-   **LLM Integration**: Ollama
-   **Package Management**: `uv`
-   **Containerization**: Docker

## ğŸš€ Getting Started

### Prerequisites

-   Python 3.12+
-   `uv` (Python package manager)
-   Docker
-   A running instance of [Ollama](https://ollama.com/) with a model downloaded.

### Method 1: Docker (Recommended)

This is the easiest and most reliable way to run the application.

**1. Configure Environment**

Create a `.env` file in the project root. This file stores your Ollama configuration.

```ini
# .env
OLLAMA_HOST="http://host.docker.internal:11434"
OLLAMA_MODEL="llama3"
```

> **Note:** `host.docker.internal` is a special DNS name that allows the Docker container to connect to services running on your host machine (like Ollama). Replace `llama3` with the model you have downloaded.

**2. Manage API Tokens**

API tokens are now managed in the `api_tokens.json` file. You can add users and generate tokens using the built-in command-line tool.

```bash
# This will create the file and add 'first-user' with a new, secure token.
python -m token_manager add first-user
```

After running the command, your `api_tokens.json` will look like this:

```json
[
  {
    "name": "first-user",
    "token": "a-long-randomly-generated-token..."
  }
]
```

You can add more users by running the command again with a different name. You can also manually edit this file.

**3. Build the Docker Image**

```bash
docker build -t dlink-translator .
```

**4. Run the Docker Container**

This command uses Docker Volumes (`-v`) to link your local data and configuration files directly into the container. This ensures that your tasks, uploaded files, and API tokens are **persistent** and will not be lost when the container stops.

```bash
docker run -d -p 8000:8000 \
  --env-file ./.env \
  -v ./uploads:/app/uploads \
  -v ./tasks.json:/app/tasks.json \
  -v ./api_tokens.json:/app/api_tokens.json \
  --rm --name dlink-translator-app dlink-translator
```

- `-d`: Run in detached mode (in the background).
- `--rm`: Automatically remove the container when it exits.
- `--name`: Assign a convenient name to the container.

The application will be available at `http://localhost:8000`.

### Method 2: Local Development

**1. Configure Environment**

Create the `.env` file as described above, but adjust `OLLAMA_HOST` for local access.

```ini
# .env
OLLAMA_HOST=http://localhost:11434
OLLAMA_MODEL=llama3
```

**2. Manage API Tokens**

Run the token manager script to create your first token:

```bash
python -m token_manager add my-local-user
```

**3. Install Dependencies**

`uv` creates a virtual environment and installs dependencies in one step.

```bash
uv sync
```

**4. Run the Web Server**

Use `uv run` to execute the `uvicorn` server.

```bash
"uv run uvicorn main:app --host 0.0.0.0 --port 8000"
```

The application will be available at `http://localhost:8000`.

## âš™ï¸ Configuration

| Item              | Required | Description                                                                                             |
| ----------------- | :------: | ------------------------------------------------------------------------------------------------------- |
| `api_tokens.json` |   Yes    | A JSON file containing a list of user objects, each with a `name` and `token`. Manages access to the UI. |
| `OLLAMA_HOST`     |   Yes    | The full URL of your running Ollama instance (e.g., `http://localhost:11434`). Set in `.env`.          |
| `OLLAMA_MODEL`    |   Yes    | The name of the Ollama model to use for translations (e.g., `llama3`, `mistral`). Set in `.env`.      |

## ğŸ“ Project Structure

```
/
â”œâ”€â”€ .dockerignore
â”œâ”€â”€ .gitignore
â”œâ”€â”€ api_tokens.json     # NEW: Manages user API tokens.
â”œâ”€â”€ cli.py              # Standalone CLI for direct translation (bypasses queue).
â”œâ”€â”€ Dockerfile          # Defines the Docker container for the application.
â”œâ”€â”€ main.py             # FastAPI application entry point, handles startup/shutdown.
â”œâ”€â”€ processor.py        # Core logic for CSV and IDML translation processing.
â”œâ”€â”€ pyproject.toml      # Project metadata and dependencies for `uv`.
â”œâ”€â”€ README.md           # This file.
â”œâ”€â”€ storage.py          # Handles reading/writing to the tasks.json file.
â”œâ”€â”€ token_manager.py    # NEW: Script to manage the api_tokens.json file.
â”œâ”€â”€ translator.py       # Contains the core `translate_text` function that calls Ollama.
â”œâ”€â”€ worker.py           # Background worker that picks up and runs tasks from the queue.
â”œâ”€â”€ routers/            # FastAPI routers for different API endpoints (tasks, idml, etc.).
â”œâ”€â”€ static/             # Frontend CSS and JavaScript files.
â””â”€â”€ templates/          # Contains the main index.html template.
```

## ğŸ¤– CLI Usage

The CLI is a separate tool for direct, scriptable translations and does **not** interact with the Web UI or the task queue.

**1. Command Structure**

```bash
uv run python cli.py [CSV_PATH] [SOURCE_LANG] [TARGET_LANG] [OPTIONS]
```

**2. Example**

To translate `example/test.csv` from English to German:

```bash
uv run python cli.py example/test.csv en de
```

**3. Options**

-   `--overwrite`: Overwrites all entries in the target column.
-   `--batch-size <NUMBER>`: Sets the number of rows to process before saving (default: 10).
-   `--model <MODEL_NAME>`: Specifies the Ollama model to use.
-   `--ollama_host <URL>`: Sets the URL for the Ollama host.

## ğŸ§ª Testing

The project includes an automated test suite to verify API endpoints and end-to-end UI functionality.

### 1. Setup

Before running the tests, please ensure you have completed the following setup steps:

**a. Install Test Dependencies**

In addition to the main packages from `uv sync`, the test suite requires its own dependencies:

```bash
# Install using pip
pip install requests pytest pytest-playwright

# Or install using uv
uv pip install requests pytest pytest-playwright
```

**b. Install Playwright Browsers**

Playwright requires dedicated browser binaries to be downloaded:

```bash
playwright install
```

**c. Set API Token**

The test scripts require a valid API token, which they read from an environment variable. Set it in your terminal:

```bash
export API_TOKEN="your-api-token-here"
```

**d. Ensure Application is Running**

The tests need to connect to a running instance of the application. Make sure you have started the server via `uv run uvicorn main:app` or Docker.

### 2. Running Tests

**a. Run All Tests**

A master script is provided to execute all tests sequentially and print a summary report.

```bash
python test/run_all_tests.py
```

**b. Run Specific Tests**

You can also run tests for individual features:

- **API Tests** (IDML Tools, Live Translator):
  ```bash
  python test/test_idml_tools.py
  ```

- **End-to-End (E2E) UI Tests** (CSV Translator):
  ```bash
  pytest test/test_csv_translator_playwright.py
  ```

**c. Debugging E2E Tests**

To watch the Playwright tests execute in a real browser window (i.e., not in headless mode), use the `--headed` flag. This is extremely useful for debugging.

```bash
pytest test/test_csv_translator_playwright.py --headed
```